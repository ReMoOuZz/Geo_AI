<%
    game = @score.game
    total_questions = game.game_questions.count
    correct_answers = @score.value
    percentage = total_questions > 0 ? (correct_answers.to_f / total_questions * 100).round : 0
    incorrect_questions = game.game_questions.joins(:user_answers)
        .where(user_answers: { user: current_user, is_correct: false })
%>

<div class="score-container" 
     data-controller="score-results" 
     data-score-results-percentage-value="<%= percentage %>" 
     data-score-results-correct-value="<%= correct_answers %>" 
     data-score-results-total-value="<%= total_questions %>">
        
    <!-- Container 1: Trophée + Message + Pourcentage -->
    <div class="score-wrapper">
        <div class="score-summary">
            <div class="trophy" data-score-results-target="trophy">
            </div>
            
            
            <div class="score-display">
                <span class="score-text" data-score-results-target="scoreText"><%= percentage %>%</span>
                <div class="score-label">de réussite</div>
            </div>
        </div>
            <h1 class="score-message" data-score-results-target="message"></h1>
        <%
            # Calcule badges obtenus quiz
            earned_badges = []
            
            # Badges de perf
            if percentage == 100
                earned_badges << "Diamant"
            elsif percentage >= 80
                earned_badges << "Médaille d'or"
            elsif percentage >= 60
                earned_badges << "Médaille d'argent"
            elsif percentage >= 30
                earned_badges << "Médaille de bronze"
            else
                earned_badges << "Poop"
            end
            
            # Badges thématiques
            if percentage >= 80
                case game.category
                when "Hydrographie et reliefs"
                earned_badges << "Montagnard"
                when "Drapeaux"
                earned_badges << "Roi de la colline"
                when "Régions et villes du monde"
                earned_badges << "Capitaliste"
                when "Géopolitique"
                earned_badges << "Diplomate"
                end
            end
            
            # Badge Serial Crotteur (si applicable)
            failed_games = current_user.scores.joins(:game).where("scores.value < ?", 3).count
            if failed_games >= 5
                earned_badges << "Serial Crotteur"
            end
        %>
       <div class="badges-obtains">
            <p>Badges obtenus</p>
            <div class="badges-icons">
                <% earned_badges.each do |badge_name| %>
                    <span class="achv-ico" title="<%= badge_name %>">
                        <% case badge_name %>
                        <% when "Diamant" %>
                            <i class="fa-solid fa-gem" style="color: #74C0FC;"></i>
                        <% when "Médaille d'or" %>
                            <i class="fa-solid fa-medal" style="color: #FFD43B;"></i>
                        <% when "Médaille d'argent" %>
                            <i class="fa-solid fa-medal" style="color: #757575ff;"></i>
                        <% when "Médaille de bronze" %>
                            <i class="fa-solid fa-medal" style="color: #9a7f1fff;"></i></span>
                        <% when "Poop" %>
                            <i class="fa-solid fa-poo" style="color: #513c1f;"></i></span>
                        <% when "Montagnard" %>
                            <i class="fa-solid fa-person-hiking" style="color: #32b38c;"></i>
                        <% when "Roi de la colline" %>
                            <i class="fa-solid fa-flag" style="color: #e11414;"></i>
                        <% when "Capitaliste" %>
                            <i class="fa-solid fa-building-columns" style="color: #B197FC;"></i>
                        <% when "Diplomate" %>
                            <i class="fa-solid fa-helmet-un" style="color: #b10196ff;"></i>
                        <% when "Serial Crotteur" %>
                            <i class="fa-solid fa-poo" style="color: #2b1b00ff;"></i>
                        <% end %>
                    </span>
                <% end %>
            </div>
        </div>
            
    

    <div class="category-info">
            <div class="category-tags">
                <% if game.category.present? %>
                    <span data-score-results-target="categoryIcon" data-category="<%= game.category.downcase %>"><%= game.category.capitalize %></span>
                <% end %>
                <% if game.difficulty.present? %>
                    <span data-score-results-target="difficultyIcon" data-difficulty="<%= game.difficulty.downcase %>"><%= game.difficulty.capitalize %></span>
                <% end %>
                <% if game.region.present? %>
                    <span data-score-results-target="regionIcon" data-region="<%= game.region.downcase %>"><%= game.region.capitalize %></span>
                <% end %>
            </div>
        </div>
        <div class="action-buttons">
            <%= link_to "Nouvelle partie", new_game_path, class: "btn btn-succes" %>
            <%= link_to "Menu principal", root_path, class: "btn" %>
        </div>
</div>
    
    <!-- Container 2: Stats + Détails -->
    <div class="score-details-container">
        <!-- Stats des réponses -->
        <div class="score-stats">
            <div class="score-progress-item">
                <div class="score-progress-header">
                    <span class="score-progress-label">
                        <i class="fa-solid fa-circle-check" style="color: #4CAF50;"></i>
                        Bonnes réponses
                    </span>
                    <span class="score-progress-value" data-score-results-target="correctCount">0</span>
                </div>
                <div class="score-progress-bar-container">
                    <div class="score-progress-bar score-progress-correct" data-score-results-target="correctBar"></div>
                </div>
            </div>
            
            <div class="score-progress-item">
                <div class="score-progress-header">
                    <span class="score-progress-label">
                        <i class="fa-solid fa-circle-xmark" style="color: #e74c3c;"></i>
                        Mauvaises réponses
                    </span>
                    <span class="score-progress-value" data-score-results-target="incorrectCount">0</span>
                </div>
                <div class="score-progress-bar-container">
                    <div class="score-progress-bar score-progress-incorrect" data-score-results-target="incorrectBar"></div>
                </div>
            </div>
        </div>
                
        <!-- Questions incorrectes -->
        <% if incorrect_questions.any? %>
            <div class="incorrect-questions">
                <h4 class="title-questions">Questions ratées</h4>
                <div class="carousel-container" data-controller="question-carousel" data-question-carousel-total-value="<%= incorrect_questions.count %>">
                    <div class="carousel-wrapper">
                        <% incorrect_questions.each_with_index do |question, index| %>
                            <div class="question-item <%= 'active' if index == 0 %>" data-question-carousel-target="slide" data-slide-index="<%= index %>">
                                <div class="question-text">
                                    <i class="fa-solid fa-circle-question" style="color: #FF0000"></i> <%= question.content %>
                                </div>
                                <div class="correct-answer">
                                    <i class="fa-solid fa-circle-check" style="color: #63E6BE;"></i> <%= question.correct_answer %>
                                </div>
                                <% if question.contexte.present? %>
                                    <div class="question-context">
                                        <i class="fa-solid fa-lightbulb" style="color: #FFD43B;"></i> <%= question.contexte %>
                                    </div>
                                <% end %>
                            </div>
                        <% end %>
                    </div>
                    
                    <!-- Navigation du carousel -->
                    <div class="carousel-nav">
                        <button data-action="click->question-carousel#previous" class="nav-btn prev-btn">❮</button>
                        <span class="slide-counter" data-question-carousel-target="counter">1 / <%= incorrect_questions.count %></span>
                        <button data-action="click->question-carousel#next" class="nav-btn next-btn">❯</button>
                    </div>
                </div>
            </div>
        <% end %>
    </div>
</div>


